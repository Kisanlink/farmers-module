# ADR: Add Farmer ID Foreign Key Relationships

## Status
Accepted - Implementation In Progress

## Context

The farmers module database schema uses a combination of `aaa_user_id` + `aaa_org_id` for identifying user ownership of records, but lacks proper foreign key relationships to the `farmers` table. This creates several issues:

1. **No Database-Level Referential Integrity**: Without FK constraints, the database cannot enforce data consistency when farmers are deleted or modified
2. **Complex Query Patterns**: Services must join through AAA fields rather than using direct relationships
3. **Inconsistent Schema**: Some tables (crops, varieties) have proper FK relationships while user tables don't
4. **Manual Cascade Logic**: Application code must handle cleanup of related records instead of database constraints

### Current State

```
farmers (id, aaa_user_id, aaa_org_id)
  ‚Üë (no FK)
  |
farms (id, aaa_user_id, aaa_org_id)  -- Should reference farmers.id
  ‚Üë (no FK)
  |
crop_cycles (id, farm_id, farmer_id)  -- farmer_id exists but no FK constraint
  ‚Üë (no FK)
  |
farm_activities (id, crop_cycle_id)   -- No farmer_id at all
```

## Decision

We will add `farmer_id` foreign key columns with proper GORM relationship tags to all user-related tables:

1. **farms**: Add `farmer_id` ‚Üí `farmers.id`
2. **crop_cycles**: Add FK constraint to existing `farmer_id` ‚Üí `farmers.id`
3. **farm_activities**: Add `farmer_id` ‚Üí `farmers.id`

All foreign keys will use `ON DELETE CASCADE` to ensure automatic cleanup of related records.

## Rationale

### Why Add Direct farmer_id FK?

**Option 1: Keep AAA Fields Only** ‚ùå
```go
// Query requires complex joins
db.Where("aaa_user_id = ? AND aaa_org_id = ?", userID, orgID)
```
- ‚ùå No referential integrity
- ‚ùå Complex queries with multiple fields
- ‚ùå No cascade delete support
- ‚ùå Harder to understand relationships

**Option 2: Add farmer_id FK** ‚úÖ (CHOSEN)
```go
// Simple, direct query
db.Where("farmer_id = ?", farmerID)
```
- ‚úÖ Database enforces integrity
- ‚úÖ Simpler queries
- ‚úÖ Automatic cascade deletes
- ‚úÖ Clear ownership model
- ‚úÖ Better performance with single indexed field

### Why ON DELETE CASCADE?

When a farmer is deleted, all their related data (farms, crop cycles, activities) should be removed:

```sql
DELETE FROM farmers WHERE id = 'FMRR-ABC123';
-- Automatically deletes:
-- - All farms owned by this farmer
-- - All crop cycles for these farms
-- - All activities in these crop cycles
```

**Alternative: ON DELETE SET NULL** ‚ùå
- Would leave orphaned records
- Business logic requires farmer ownership
- No use case for crops/activities without farmer

**Alternative: Application-level cascade** ‚ùå
- Error-prone (easy to miss related tables)
- Less performant (multiple queries)
- Not transaction-safe
- Doesn't prevent direct SQL deletion

### Why farmer_id in farm_activities?

Activities belong to crop cycles, which belong to farmers. Why add direct `farmer_id`?

**Option 1: Query through crop_cycle** ‚ùå
```sql
SELECT * FROM farm_activities fa
JOIN crop_cycles cc ON fa.crop_cycle_id = cc.id
WHERE cc.farmer_id = 'FMRR-ABC123'
```
- Requires join for every farmer-level query
- Slower for reports and analytics

**Option 2: Direct farmer_id** ‚úÖ (CHOSEN)
```sql
SELECT * FROM farm_activities
WHERE farmer_id = 'FMRR-ABC123'
```
- Single-table query
- Indexed lookup
- Supports farmer-level reports
- Maintains denormalization for performance

**Trade-off**: Slight denormalization for significant query performance improvement.

### Why VARCHAR(255) for farmer_id?

**Option 1: UUID**
- Generated by `gen_random_uuid()`
- 128-bit, 36 characters
- Standard database type

**Option 2: VARCHAR(255)** ‚úÖ (CHOSEN)
- Custom ID format: `FMRR-XXXXXXXX` (hash-based)
- Used by kisanlink-db base models
- Consistent with existing `farmers.id`
- Human-readable identifiers
- Supports existing ID generation system

### Why Not Add farmer_id to Junction Tables?

Tables like `farm_soil_types` and `farm_irrigation_sources` don't get `farmer_id`:

```
farm_soil_types (id, farm_id, soil_type_id)
                     ‚Üì
                   farms (farmer_id)
                     ‚Üì
                  farmers (id)
```

**Rationale**:
- Violates normalization (farmer_id derivable from farm_id)
- Adds redundant data
- Increases maintenance burden
- Junction tables link farms to master data, not farmers to master data

## Consequences

### Positive

1. **Database Integrity**: FK constraints prevent orphaned records
2. **Simpler Queries**: Direct relationships eliminate complex joins
3. **Automatic Cleanup**: CASCADE deletes handle related records
4. **Better Performance**: Indexed `farmer_id` enables fast lookups
5. **Clearer Model**: Schema explicitly shows ownership
6. **Developer Experience**: GORM relationships simplify repository code

### Negative

1. **Migration Complexity**: Must backfill existing records
2. **Denormalization**: `farm_activities.farmer_id` is derivable from `crop_cycle_id`
3. **Circular Import**: `farm` package importing `farmer` requires care
4. **Breaking Change**: Requires schema migration in production

### Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| Data migration fails | Test in staging, include rollback SQL |
| Orphaned records exist | Migration includes data cleanup |
| Performance impact | Add indexes before FK constraints |
| Circular imports | Keep relationship fields optional, use interfaces |

## Alternatives Considered

### 1. Keep AAA Fields Only
**Rejected**: No referential integrity, complex queries

### 2. Use Composite Foreign Keys
```sql
FOREIGN KEY (aaa_user_id, aaa_org_id) REFERENCES farmers(aaa_user_id, aaa_org_id)
```
**Rejected**:
- Multi-column indexes less efficient
- More complex to query
- Requires unique constraint on composite key in farmers table

### 3. Add farmer_id But Keep as UUID
**Rejected**: Inconsistent with existing ID system using VARCHAR hash-based IDs

### 4. Only Add FK to farms, Derive Others
**Rejected**: Requires joins for every query, defeats purpose of optimization

## Implementation Notes

### Phase 1: Schema Changes ‚úÖ
- Update entity models
- Create migration SQL
- Verify compilation

### Phase 2: Service Layer Updates üîÑ
- Update services to populate `farmer_id` when creating records
- Modify queries to use `farmer_id` instead of AAA fields
- Add validation for `farmer_id` presence

### Phase 3: Testing üîÑ
- Integration tests for cascade delete
- Migration tests with sample data
- Performance benchmarks

### Phase 4: Deployment üîÑ
- Run migration in staging
- Verify data integrity
- Deploy to production
- Monitor query performance

## References

- Entity models: `internal/entities/`
- Migration: `internal/db/migrations/003_add_farmer_id_foreign_keys.sql`
- Database setup: `internal/db/db.go`
- kisanlink-db base models: `github.com/Kisanlink/kisanlink-db/pkg/base`

## Decision Date
2025-10-13

## Decision Makers
- System Architect
- Backend Engineering Team

## Review Date
2025-11-13 (30 days post-implementation)
