# Production Environment Overrides
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up
# WARNING: This configuration is for reference. In production, use orchestration platforms like Kubernetes.

version: '3.9'

services:
  # ============================================================================
  # Farmers Service - Production Configuration
  # ============================================================================
  farmers-service:
    # Use versioned image from registry
    image: ${DOCKER_REGISTRY:-ghcr.io/kisanlink}/farmers-module:${VERSION:-1.0.0}
    container_name: farmers-service-prod
    restart: always

    # Production environment variables
    environment:
      - ENVIRONMENT=production
      - LOG_LEVEL=warn
      - GIN_MODE=release
      - ENABLE_TRACING=true
      - ENABLE_METRICS=true

      # Database configuration (MUST use external managed database)
      - DB_POSTGRES_HOST=${DB_POSTGRES_HOST}
      - DB_POSTGRES_PORT=${DB_POSTGRES_PORT:-5432}
      - DB_POSTGRES_USER=${DB_POSTGRES_USER}
      - DB_POSTGRES_PASSWORD=${DB_POSTGRES_PASSWORD}
      - DB_POSTGRES_DBNAME=${DB_POSTGRES_DBNAME}
      - DB_POSTGRES_SSLMODE=require
      - DB_POSTGRES_MAX_CONNS=50

      # AAA Service configuration (production AAA service)
      - AAA_ENABLED=true
      - AAA_GRPC_ADDR=${AAA_GRPC_ADDR}
      - AAA_REQUEST_TIMEOUT=3s
      - AAA_RETRY_ATTEMPTS=2

      # Observability (production monitoring)
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT}

      # CORS Configuration (production)
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-https://app.kisanlink.in,https://admin.kisanlink.in}
      - CORS_ALLOW_CREDENTIALS=true

    # Strict resource limits
    deploy:
      mode: replicated
      replicas: 2
      resources:
        limits:
          cpus: '4'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: rollback

    # Production health check
    healthcheck:
      interval: 15s
      timeout: 3s
      retries: 3
      start_period: 45s

    # Security hardening for production
    security_opt:
      - no-new-privileges:true
    read_only: true  # Read-only filesystem
    tmpfs:
      - /tmp:size=100M,mode=1777,noexec,nosuid,nodev

    # Production logging
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"
        labels: "environment=production,service=farmers-module"
        tag: "{{.Name}}/{{.ID}}"

    # No volume mounts in production (stateless)
    volumes: []

  # ============================================================================
  # PostgreSQL - Production Configuration
  # ============================================================================
  # NOTE: In production, you should use a managed database service like:
  # - AWS RDS for PostgreSQL
  # - Google Cloud SQL
  # - Azure Database for PostgreSQL
  # - DigitalOcean Managed Databases
  #
  # This service definition is for reference only.
  # Comment out or remove in actual production deployments.
  # ============================================================================
  postgres:
    # In production, this service should NOT be deployed via Docker Compose
    # Use external managed database instead
    profiles:
      - local-testing-only

    container_name: farmers-postgres-prod
    restart: always

    # NEVER expose PostgreSQL port in production
    ports: []

    # Production database configuration
    environment:
      - POSTGRES_USER=${DB_POSTGRES_USER}
      - POSTGRES_PASSWORD=${DB_POSTGRES_PASSWORD}
      - POSTGRES_DB=${DB_POSTGRES_DBNAME}
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=en_US.UTF-8 --lc-ctype=en_US.UTF-8

    # Production-optimized PostgreSQL settings
    command:
      - "postgres"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "shared_buffers=512MB"
      - "-c"
      - "effective_cache_size=2GB"
      - "-c"
      - "maintenance_work_mem=128MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=16MB"
      - "-c"
      - "default_statistics_target=100"
      - "-c"
      - "random_page_cost=1.1"
      - "-c"
      - "effective_io_concurrency=200"
      - "-c"
      - "work_mem=2621kB"
      - "-c"
      - "min_wal_size=2GB"
      - "-c"
      - "max_wal_size=8GB"
      - "-c"
      - "max_worker_processes=4"
      - "-c"
      - "max_parallel_workers_per_gather=2"
      - "-c"
      - "max_parallel_workers=4"
      - "-c"
      - "max_parallel_maintenance_workers=2"
      - "-c"
      - "log_statement=none"
      - "-c"
      - "log_duration=off"
      - "-c"
      - "log_min_duration_statement=5000"
      - "-c"
      - "ssl=on"

    # Strict resource limits
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '2'
          memory: 2G

    # Production health check
    healthcheck:
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Maximum security
    security_opt:
      - no-new-privileges:true

    # Production logging
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

    # Use named volume with backup strategy
    volumes:
      - postgres-prod-data:/var/lib/postgresql/data

# ============================================================================
# Production Volumes
# ============================================================================
volumes:
  postgres-prod-data:
    name: farmers-postgres-prod-data
    driver: local
    # In real production, use a volume driver that supports:
    # - Automated backups
    # - Point-in-time recovery
    # - Encryption at rest
    # - High availability
    # Example: Use cloud provider's persistent disk (AWS EBS, GCP PD, Azure Disk)
